# æ³•å¾‹å•ç­” RAG - åµŒå…¥æ¨¡å‹å¾®èª¿æ¡†æ¶

ä½¿ç”¨å°æ¯”å­¸ç¿’ï¼ˆContrastive Learningï¼‰å¾®èª¿ç¹é«”ä¸­æ–‡åµŒå…¥æ¨¡å‹ï¼Œå°ˆç‚ºæ³•å¾‹å•ç­” RAG ç³»çµ±å„ªåŒ–ã€‚

## å°ˆæ¡ˆæ¦‚è¿°

æœ¬å°ˆæ¡ˆé€éä»¥ä¸‹æµç¨‹å¾®èª¿åµŒå…¥æ¨¡å‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ³•å¾‹ JSON è³‡æ–™  â”‚ â”€â”€â–º â”‚  LLM ç”Ÿæˆå•ç­”å°  â”‚ â”€â”€â–º â”‚ ç”Ÿæˆæ­£/è² æ¨£æœ¬é…å°â”‚ â”€â”€â–º â”‚  å°æ¯”å­¸ç¿’å¾®èª¿   â”‚
â”‚  (æ³•å‹™éƒ¨æ ¼å¼)    â”‚     â”‚  (Ollama)       â”‚     â”‚  (å›°é›£è² æ¨£æœ¬)   â”‚     â”‚  (MPS åŠ é€Ÿ)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæ¦‚å¿µ

- **æ­£æ¨£æœ¬**ï¼šèªæ„ç›¸ä¼¼çš„å•é¡Œ â†’ åœ¨å‘é‡ç©ºé–“ä¸­æ‹‰è¿‘è·é›¢
- **è² æ¨£æœ¬**ï¼šèªæ„ä¸åŒä½†å®¹æ˜“æ··æ·†çš„å•é¡Œ â†’ åœ¨å‘é‡ç©ºé–“ä¸­æ¨é è·é›¢
- **å°æ¯”å­¸ç¿’**ï¼šé€é TripletLoss è®“æ¨¡å‹å­¸æœƒå€åˆ†ç›¸ä¼¼èˆ‡ä¸ç›¸ä¼¼çš„æ³•å¾‹å•é¡Œ

## ç’°å¢ƒéœ€æ±‚

- Python 3.11+
- macOS with Apple Silicon (M1/M2/M3/M4) æˆ– CUDA GPU
- [Ollama](https://ollama.ai/) æœ¬åœ° LLM

## å¿«é€Ÿé–‹å§‹

### 1. å»ºç«‹è™›æ“¬ç’°å¢ƒ

```bash
cd /path/to/project
python3.11 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### 2. æº–å‚™æ³•å¾‹è³‡æ–™

å°‡æ³•å‹™éƒ¨æ³•è¦è³‡æ–™åº« JSON æª”æ¡ˆæ”¾å…¥ `data/raw/laws/` ç›®éŒ„ã€‚

æ”¯æ´çš„ JSON æ ¼å¼ï¼š
```json
{
  "Laws": [
    {
      "LawName": "æ°‘æ³•",
      "LawCategory": "æ°‘äº‹",
      "LawArticles": [
        {
          "ArticleType": "A",
          "ArticleNo": "ç¬¬ 1 æ¢",
          "ArticleContent": "æ¢æ–‡å…§å®¹..."
        }
      ]
    }
  ]
}
```

### 3. æŸ¥è©¢æ³•è¦åç¨±

```bash
# æœå°‹åŒ…å«é—œéµå­—çš„æ³•è¦
python scripts/list_laws.py åˆ‘æ³•
python scripts/list_laws.py å‹å‹•

# é¡¯ç¤ºçµ±è¨ˆ
python scripts/list_laws.py
```

### 4. ç”Ÿæˆå•ç­”å°

```bash
# æ¸¬è©¦æ¨¡å¼ï¼ˆå¿«é€Ÿé©—è­‰ï¼‰
python scripts/generate_qa_from_laws.py --test

# æŒ‡å®šç‰¹å®šæ³•è¦ï¼ˆç²¾ç¢ºåŒ¹é…ï¼‰
python scripts/generate_qa_from_laws.py --filter æ°‘æ³• ä¸­è¯æ°‘åœ‹åˆ‘æ³•

# åŒ…å«åŒ¹é…ï¼ˆè™•ç†æ‰€æœ‰å«é—œéµå­—çš„æ³•è¦ï¼‰
python scripts/generate_qa_from_laws.py --contains å‹å‹•

# è‡ªè¨‚åƒæ•¸
python scripts/generate_qa_from_laws.py \
    --filter æ°‘æ³• \
    --max-articles 20 \
    --qa-per-article 3
```

### 5. ç”Ÿæˆå°æ¯”å­¸ç¿’é…å°

```bash
python scripts/generate_pairs.py
```

### 6. å¾®èª¿åµŒå…¥æ¨¡å‹

```bash
python scripts/train_embedding.py
```

## å°ˆæ¡ˆçµæ§‹

```
.
â”œâ”€â”€ configs/
â”‚   â””â”€â”€ training_config.yaml     # è¨“ç·´åƒæ•¸è¨­å®š
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ raw/
â”‚   â”‚   â”œâ”€â”€ laws/                # æ³•å¾‹ JSON è³‡æ–™ (éœ€è‡ªè¡Œæ”¾å…¥)
â”‚   â”‚   â””â”€â”€ generated_qa.json    # LLM ç”Ÿæˆçš„å•ç­”å°
â”‚   â””â”€â”€ pairs/
â”‚       â””â”€â”€ training_pairs.json  # å°æ¯”å­¸ç¿’é…å°
â”œâ”€â”€ models/
â”‚   â””â”€â”€ finetuned/               # å¾®èª¿å¾Œçš„æ¨¡å‹
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ list_laws.py             # æŸ¥è©¢æ³•è¦åç¨±
â”‚   â”œâ”€â”€ generate_qa_from_laws.py # Step 1: ç”Ÿæˆå•ç­”å°
â”‚   â”œâ”€â”€ generate_pairs.py        # Step 2: ç”Ÿæˆé…å°
â”‚   â””â”€â”€ train_embedding.py       # Step 3: å¾®èª¿è¨“ç·´
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ qa_generator.py          # å•ç­”ç”Ÿæˆå™¨
â”‚   â”œâ”€â”€ pair_generator.py        # é…å°ç”Ÿæˆå™¨
â”‚   â”œâ”€â”€ contrastive_trainer.py   # å°æ¯”å­¸ç¿’è¨“ç·´å™¨
â”‚   â””â”€â”€ data_loader.py           # è³‡æ–™è¼‰å…¥å™¨
â””â”€â”€ requirements.txt
```

## æŠ€è¡“ç´°ç¯€

### åŸºåº•æ¨¡å‹

- **æ¨¡å‹**: `BAAI/bge-base-zh-v1.5`
- **ç¶­åº¦**: 768
- **ç‰¹é»**: é‡å°ä¸­æ–‡å„ªåŒ–ï¼Œç¤¾ç¾¤å»£æ³›ä½¿ç”¨

### å°æ¯”å­¸ç¿’

- **Loss Function**: TripletLoss
- **è¨“ç·´ç­–ç•¥**:
  - Anchor: åŸå§‹å•é¡Œ
  - Positive: ç›¸ä¼¼å•é¡Œè®Šé«” / å°æ‡‰ç­”æ¡ˆ
  - Negative: å›°é›£è² æ¨£æœ¬ï¼ˆçœ‹ä¼¼ç›¸é—œä½†ç­”æ¡ˆä¸åŒï¼‰

### ç¡¬é«”åŠ é€Ÿ

- **Apple Silicon**: ä½¿ç”¨ MPS (Metal Performance Shaders)
- **NVIDIA GPU**: ä½¿ç”¨ CUDA

## åƒæ•¸èªªæ˜

### generate_qa_from_laws.py

| åƒæ•¸ | èªªæ˜ | é è¨­å€¼ |
|------|------|--------|
| `--test` | æ¸¬è©¦æ¨¡å¼ (5 æ³•è¦ Ã— 3 æ¢) | - |
| `--full` | å®Œæ•´æ¨¡å¼ (æ‰€æœ‰æ³•è¦) | - |
| `--filter` | ç²¾ç¢ºåŒ¹é…æ³•è¦åç¨± | - |
| `--contains` | åŒ…å«åŒ¹é…æ³•è¦åç¨± | - |
| `--max-laws` | æœ€å¤šè™•ç†å¹¾éƒ¨æ³•è¦ | 50 |
| `--max-articles` | æ¯éƒ¨æ³•è¦æœ€å¤šå¹¾æ¢ | 10 |
| `--qa-per-article` | æ¯æ¢ç”Ÿæˆå¹¾çµ„å•ç­” | 2 |

### training_config.yaml

```yaml
model:
  name: "BAAI/bge-base-zh-v1.5"

training:
  batch_size: 16
  learning_rate: 2.0e-5
  num_epochs: 3

hardware:
  use_mps: true  # Apple Silicon
```

## é–‹ç™¼é€²åº¦

### âœ… å·²å®Œæˆ

- [x] å°ˆæ¡ˆæ¶æ§‹è¨­è¨ˆ
- [x] è™›æ“¬ç’°å¢ƒèˆ‡ä¾è³´å®‰è£
- [x] æ³•å‹™éƒ¨æ³•è¦è³‡æ–™åº«è¼‰å…¥å™¨
- [x] LLM å•ç­”å°ç”Ÿæˆå™¨ (Ollama)
- [x] æ­£è² æ¨£æœ¬é…å°ç”Ÿæˆå™¨
- [x] å°æ¯”å­¸ç¿’è¨“ç·´å™¨ (MPS æ”¯æ´)
- [x] æ³•è¦åç¨±æŸ¥è©¢å·¥å…·
- [x] ç²¾ç¢º/åŒ…å«åŒ¹é…éæ¿¾åŠŸèƒ½

### ğŸ”„ é€²è¡Œä¸­

- [ ] å¤§è¦æ¨¡å•ç­”å°ç”Ÿæˆ
- [ ] å®Œæ•´è¨“ç·´æµç¨‹æ¸¬è©¦

### ğŸ“‹ å¾…å®Œæˆ

- [ ] æ¨¡å‹è©•ä¼°æŒ‡æ¨™ (MRR, Recall@K)
- [ ] å¾®èª¿å‰å¾Œæ•ˆæœæ¯”è¼ƒ
- [ ] RAG ç³»çµ±æ•´åˆ
- [ ] å‘é‡è³‡æ–™åº«æ•´åˆ (ChromaDB/Milvus)

## License

MIT License
